---
title: "Dimensionality reduction"
---
  
```{r load_modules, echo=FALSE, include=FALSE}
library(Seurat)
```

# Define settings

Define I/O
```{r define_io, echo=FALSE}
source("/Users/ricard/10x_gastrulation_TetChimera/settings.R")
io$outdir <- paste0(io$basedir,"/results/dimensionality_reduction")
```

Define options
```{r}
opts$batches <- c(
  "E75_TET_TKO_L002", 
  "E75_WT_Host_L001"
  # "E85_Rep1_TET_TKO_L004", 
  # "E85_Rep1_WT_Host_L003", 
  # "E85_Rep2_TET_TKO_L006", 
  # "E85_Rep2_WT_Host_L005", 
  # "SIGAE4_E105_3_TET123_Chimera_Host_L005", 
  # "SIGAF4_E105_3_TET123_Chimera_TKO_L006", 
  # "SIGAG4_E105_5_TET123_Chimera_Host_L007", 
  # "SIGAH4_E105_5_TET123_Chimera_TKO_L008"
)
```

Update sample metadata
```{r load_metadata, echo=FALSE}
sample_metadata <- sample_metadata %>%
  .[batch%in%opts$batches]
table(sample_metadata$batch)
```

# Load data

Load RNA expression data as Seurat object
```{r load_data, echo=FALSE}
seurat <- readRDS(io$seurat)[,sample_metadata$cell]
dim(seurat)
```

Add metadata to the Seurat object
```{r}
foo <- sample_metadata %>% as.data.frame %>% tibble::column_to_rownames("cell") %>%
  .[colnames(seurat),]

stopifnot(colnames(seurat) == rownames(foo))
# seurat <- AddMetaData(seurat, foo)  # not working????
seurat@meta.data <- foo
```

# Parse data 

Remove genes that are not expressed
```{r}
foo <- Matrix::rowMeans(seurat@assays$RNA@counts)
seurat <- subset(seurat, features = names(which(foo>1e-6)))
```

Normalise
```{r}
# SCTransform
# seurat <- SCTransform(seurat)

# LogNormalize
seurat <- NormalizeData(seurat, normalization.method = "LogNormalize")

# Scale
seurat <- ScaleData(seurat)
```

Change gene names from ENSEMBL to symbols
```{r}
gene_metadata <- fread(io$gene_metadata) %>% .[,c("ens_id","symbol")] %>%
  .[symbol!="" & ens_id%in%rownames(seurat)]

gene_metadata$symbol[duplicated(gene_metadata$symbol)]
seurat <- seurat[rownames(seurat)%in%gene_metadata$ens_id,]
foo <- gene_metadata$symbol; names(foo) <- gene_metadata$ens_id
new.names <- foo[rownames(seurat)]

# Sanity cehcks
stopifnot(sum(is.na(new.names))==0)
stopifnot(sum(duplicated(new.names))==0)

# Rename seurat objects manually
rownames(seurat@assays$RNA@counts) <- new.names
rownames(seurat@assays$RNA@data) <- new.names
rownames(seurat@assays$RNA@scale.data) <- new.names
seurat[["RNA"]]@meta.features <- data.frame(row.names=new.names)
```

# Select HVG

Option 1, using FindVariableFeatures
```{r}
seurat <- FindVariableFeatures(seurat, selection.method = 'vst', nfeatures = 1000)
# head(seurat@assays$RNA@var.features)
```

Option 2, using precomputed marker genes
```{r}
# marker_genes.dt <- fread(io$atlas.marker_genes)
# hvg <- unique(marker_genes.dt$ens_id)
# hvg <- hvg[hvg%in%rownames(seurat)]
# 
# seurat@assays$RNA@var.features <- hvg
```

# Dimensionality reduction

PCA 
```{r message=FALSE}
seurat <- RunPCA(seurat, 
  features = VariableFeatures(seurat),
  npcs = ,
  verbose = FALSE
)
```

Correlation between PCs and batch
```{r}
# r <- cor(
#   seurat@reductions$pca@cell.embeddings,
#   as.numeric(as.factor(seurat@meta.data$batch))
# )[,1]
# r
```

UMAP
```{r}
seurat <- RunUMAP(seurat, 
  dims = 1:25,
  # dims = which(r<=0.5),
  reduction = "pca"
)
```

# Plot 

```{r}
# Idents(seurat) <- "batch"
Idents(seurat) <- "celltype.mapped"
# levels(seurat)
```

```{r}
# DimPlot(seurat, label = FALSE, reduction = 'umap')
DimPlot(seurat, label = FALSE, reduction = 'umap', cols = opts$celltype.colors) + NoLegend()
```

Explore marker genes
```{r}
genes.to.plot <- c("Apom")

FeaturePlot(seurat, features = genes.to.plot, reduction='umap')
```

